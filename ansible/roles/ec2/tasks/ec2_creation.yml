---
#######
#@author: Mathieu Coavoux
#
#Input parameters:
# AWS_ACCESS_KEY: Amazon access key. This is injected by Jenkins
# AWS_SECRET_KEY: Amazon secret key. This is injected by Jenkins
# ENV_INSTANCE_TYPE: Type of the instance. We didn't find the REST api which expose all the types yet
# ENV_VM_TYPE: The VM type we want to create. The only value available here is: java_10
# ENV_EC2_NUMBER: number of instance to create
# ENV_REGION_NAME: the Amazon region http://docs.aws.amazon.com/general/latest/gr/rande.html#ec2_region
# ENV_INSTANCE_TAG_NAME: the name of the instance
# ENV_AUTO_CORRELATION_ID: a unique ID generated by Jenkins
#Description:
# Create an EC2 instance based on the input parameters entered in the Jenkins job
# It will wait until the EC2 is created and it will copy the instance id in a properties file
- name: "EC2 creation"
  ec2:
    aws_access_key: "{{AWS_ACCESS_KEY}}"
    aws_secret_key: "{{AWS_SECRET_KEY}}"
    instance_type: "{{ENV_INSTANCE_TYPE}}"
    image: "{{ami_type.get(ENV_VM_TYPE).id}}"
    wait: yes
    count: "{{ENV_EC2_NUMBER}}"
    region: "{{ENV_REGION_NAME}}"
    instance_tags:
      Name: "{{ENV_INSTANCE_TAG_NAME}}"
      volumes:
    - device_name: /dev/xvda
      volume_type: gp2
      volume_size: 8
    assign_public_ip: no
    register: amazon_creation

- debug:
    msg: "{{amazon_creation}}"

#This will push the key/value pair into the REDIS cache.
#@see README.MD#Redis_cache_configuration
#EN
- name: "Push instance id"
  set_fact:
    "{{ENV_AUTO_CORRELATION_ID}}" :
      "instance_ids" : "{{amazon_creation.instance_ids}}"


